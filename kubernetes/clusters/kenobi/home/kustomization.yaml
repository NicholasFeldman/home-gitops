apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: home

resources:
  - ingressroute.yaml
  - namespace.yaml
  - secrets/sealed-nextcloud.yaml
  - secrets/sealed-nextcloud-postgresql.yaml

helmCharts:
  - releaseName: mealie
    name: mealie
    version: 3.3.0
    repo: https://k8s-at-home.com/charts/
    namespace: home
    valuesInline:
      env:
        TZ: America/New_York
      image:
        tag: v0.5.5
      persistence:
        config:
          enabled: true

  - releaseName: nextcloud
    name: nextcloud
    version: 2.12.0
    repo: https://nextcloud.github.io/helm
    namespace: home
    valuesInline:
      nextcloud:
        host: nextcloud.feldman.tech
        existingSecret:
          enabled: true
          secretName: nextcloud
          usernameKey: nextcloud-username
          passwordKey: nextcloud-password
        configs:
          https.config.php: |-
            <?php
            $CONFIG = array(
              'overwriteprotocol' => 'https',
            );
        extraVolumeMounts:
          - name: ilum-media
            mountPath: /mnt/ilum-media
          - name: ilum-documents
            mountPath: /mnt/ilum-documents
        extraVolumes:
          - name: ilum-media
            nfs:
              server: "192.168.40.111"
              path: "/volume1/Media"
              readOnly: false
          - name: ilum-documents
            nfs:
              server: "192.168.40.111"
              path: "/volume1/Documents"
              readOnly: false

      persistence:
        enabled: true
        size: 2Gi
        nextcloudData:
          enabled: true
          size: 256Gi

      livenessProbe:
        enabled: false
      readinessProbe:
        enabled: false

      internalDatabase:
        enabled: false
      externalDatabase:
        enabled: true
        type: postgresql
        host: nextcloud-postgresql.database.svc.cluster.local
        database: nextcloud
        existingSecret:
          enabled: true
          secretName: nextcloud-postgresql
          usernameKey: username
          passwordKey: password




