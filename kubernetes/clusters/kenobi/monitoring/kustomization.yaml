apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ingressroute.yaml
  - namespace.yaml
  - secrets/sealed-grafana-ini.yaml
  - secrets/sealed-grafana-postgresql.yaml
  - secrets/sealed-influxdb.yaml

helmCharts:
  - releaseName: grafana-postgresql
    name: postgresql
    version: 11.0.1
    repo: https://charts.bitnami.com/bitnami
    namespace: monitoring
    valuesInline:
      # https://github.com/bitnami/charts/tree/master/bitnami/postgresql#postgresql-common-parameters
      auth:
        username: grafana
        database: grafana
        existingSecret: grafana-postgresql
  - releaseName: grafana
    name: grafana
    version: 7.6.4
    repo: https://charts.bitnami.com/bitnami
    namespace: monitoring
    valuesInline:
      admin:
        user: admin
        password: changeme
      config:
        useGrafanaIniFile: true
        grafanaIniSecret: grafana-ini
      grafana:
        replicaCount: 2
        podAnnotations:
          telegraf.influxdata.com/class: infra
          telegraf.influxdata.com/interval: 30s
          telegraf.influxdata.com/path: /metrics
          telegraf.influxdata.com/port: "3000"
          telegraf.influxdata.com/scheme: http
      persistence:
        enabled: false
  - releaseName: influxdb
    name: influxdb
    version: 3.0.2
    repo: https://charts.bitnami.com/bitnami
    namespace: monitoring
    valuesInline:
      auth:
        existingSecret: influxdb
        admin:
          username: admin
          org: Feldman
          bucket: Default
  - releaseName: telegraf-operator
    name: telegraf-operator
    version: 1.3.4
    repo: https://helm.influxdata.com
    namespace: monitoring
    valuesInline:
      classes.data: ~ # Disable templated secret
