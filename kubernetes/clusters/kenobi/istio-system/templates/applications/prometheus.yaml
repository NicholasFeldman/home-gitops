apiVersion: argoproj.io/v1alpha1
kind: Application

metadata:
  name: kenobi-{{.Release.Namespace}}-prometheus
  namespace: argocd

spec:
  destination:
    namespace: {{.Release.Namespace}}
    name: in-cluster
  project: kenobi
  source:
    chart: prometheus
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 15.10.5
    helm:
      releaseName: prometheus
      values: |-
        alertmanager:
          enabled: false
        nodeExporter:
          enabled: false
        pushGateway:
          enabled: false
        serverFiles:
          prometheus.yml:
            scrape_configs:
              - job_name: 'istiod'
                kubernetes_sd_configs:
                  - role: endpoints
                    namespaces:
                      names:
                        - istio-system
                relabel_configs:
                  - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
                    action: keep
                    regex: istiod;http-monitoring
