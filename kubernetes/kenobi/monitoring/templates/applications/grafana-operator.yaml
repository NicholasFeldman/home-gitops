apiVersion: argoproj.io/v1alpha1
kind: Application

metadata:
  name: kenobi-{{.Release.Namespace}}-grafana-operator
  namespace: argocd

spec:
  destination:
    namespace: {{.Release.Namespace}}
    name: in-cluster
  project: kenobi
  source:
    chart: grafana-operator
    repoURL: https://charts.bitnami.com/bitnami
    targetRevision: 2.6.*
    helm:
      releaseName: grafana-operator
      values: |
        grafana:
          image:
            tag: 9.0.7-debian-11-r0
          replicaCount: 2
          updateStrategy:
            type: RollingUpdate
          envFrom:
            - secretRef:
                name: grafana-env
          config:
            server:
              domain: grafana.feldman.in
              root_url: https://grafana.feldman.in
            database:
              type: postgres
              host: postgresql-ha-pgpool.database.svc.cluster.local
              name: grafana
              user: grafana
              # password provided by env
            auth:
              disable_login_form: true
            auth.generic_oauth:
              enabled: true
              client_id: grafana.feldman.in
              scopes: profile
              auth_url: https://auth.feldman.tech/auth/realms/Feldman/protocol/openid-connect/auth
              token_url: https://auth.feldman.tech/auth/realms/Feldman/protocol/openid-connect/token
              api_url: https://auth.feldman.tech/auth/realms/Feldman/protocol/openid-connect/userinfo
              role_attribute_path: "contains(roles[*], 'admin') && 'Admin' || contains(roles[*], 'editor') && 'Editor' || 'Viewer'"